<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×”×•×Ÿ ×•×”×ª×—×™×™×‘×•×™×•×ª</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Rubik', sans-serif; 
            background-color: #f8fafc;
            color: #334155;
        }

        .card-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            padding: 16px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .entry-card {
            background: #ffffff;
            border-bottom: 1px solid #f1f5f9;
            padding: 12px 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }
        .entry-card:hover { background: #f8fafc; }
        .entry-card:last-child { border-bottom: none; }

        .icon-box {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .btn-action {
            background: #0f172a;
            color: white;
            border-radius: 8px;
            padding: 10px;
            font-weight: bold;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-action:hover { background: #334155; }

        .tab-btn {
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            background: #f1f5f9;
            color: #64748b;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .tab-btn.active-save { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .tab-btn.active-loan { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        #toast {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 10px 24px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            font-size: 0.9rem;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50">

    <div id="toast">âœ… ×”× ×ª×•× ×™× × ×©××¨×•!</div>

    <header class="bg-white border-b border-gray-200 px-6 py-3 shadow-sm z-10 shrink-0">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex items-center gap-6 w-full md:w-auto justify-center md:justify-start">
                <div class="text-center md:text-right">
                    <h1 class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">×©×•×•×™ × ×§×™</h1>
                    <div id="netWorth" class="text-2xl font-bold text-slate-800" dir="ltr">â‚ª0</div>
                </div>
                <div class="h-8 w-px bg-gray-200"></div>
                <div class="flex gap-4 text-center">
                    <div>
                        <div class="text-[10px] text-emerald-600 font-bold">× ×›×¡×™×</div>
                        <div id="totalAssets" class="text-sm font-bold text-emerald-700">â‚ª0</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-red-500 font-bold">×—×•×‘×•×ª</div>
                        <div id="totalLiabilities" class="text-sm font-bold text-red-600">â‚ª0</div>
                    </div>
                </div>
            </div>

            <button onclick="toggleModal()" class="btn-action md:w-auto px-6 py-2 text-sm shadow-lg shadow-slate-200">
                + ×¤×¢×•×œ×” ×—×“×©×”
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 custom-scroll">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">

            <div class="flex flex-col gap-4">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-emerald-100 text-emerald-700 p-1.5 rounded-lg text-xs">ğŸ’°</span>
                    <h2 class="text-slate-700 font-bold">×”× ×›×¡×™× ×©×œ×™</h2>
                </div>
                
                <div class="card-box h-48 relative justify-center">
                    <canvas id="savingsChart"></canvas>
                </div>

                <div class="card-box flex-row items-center gap-6 min-h-[140px]">
                    <div class="w-24 h-24 relative shrink-0">
                        <canvas id="savingsPie"></canvas>
                    </div>
                    <div id="savingsLegend" class="flex-1 text-xs space-y-1.5 overflow-y-auto max-h-28 custom-scroll pr-1"></div>
                </div>

                <div class="card-box flex-1 min-h-[250px] p-0 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 text-xs font-bold text-gray-500">×¤×™×¨×•×˜ × ×›×¡×™×</div>
                    <div id="savingsList" class="flex-1 overflow-y-auto custom-scroll p-2 h-48"></div>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-red-100 text-red-700 p-1.5 rounded-lg text-xs">ğŸ“‰</span>
                    <h2 class="text-slate-700 font-bold">×”×”×ª×—×™×™×‘×•×™×•×ª ×©×œ×™</h2>
                </div>

                <div class="card-box h-48 relative justify-center">
                    <canvas id="loansChart"></canvas>
                </div>

                <div class="card-box flex-row items-center gap-6 min-h-[140px]">
                    <div class="w-24 h-24 relative shrink-0">
                        <canvas id="loansPie"></canvas>
                    </div>
                    <div id="loansLegend" class="flex-1 text-xs space-y-1.5 overflow-y-auto max-h-28 custom-scroll pr-1"></div>
                </div>

                <div class="card-box flex-1 min-h-[250px] p-0 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 text-xs font-bold text-gray-500">×¤×™×¨×•×˜ ×”×œ×•×•××•×ª</div>
                    <div id="loansList" class="flex-1 overflow-y-auto custom-scroll p-2 h-48"></div>
                </div>
            </div>

        </div>
    </main>

    <div id="addModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl overflow-y-auto max-h-[90vh] custom-scroll">
            
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-slate-800">×¢×“×›×•×Ÿ × ×ª×•× ×™×</h3>
                <button onclick="toggleModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 transition">âœ•</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5 p-1 bg-gray-50 rounded-xl">
                <div id="tabSavings" onclick="switchTab('savings')" class="tab-btn active-save">×”×•×¡×£ × ×›×¡ ğŸ’°</div>
                <div id="tabLoans" onclick="switchTab('loans')" class="tab-btn">×”×•×¡×£ ×—×•×‘ ğŸ“‰</div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×ª××¨×™×š</label>
                        <input type="date" id="dateInput" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-slate-200 outline-none">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×¡×›×•× ×¢×“×›× ×™</label>
                        <input type="number" id="amountInput" placeholder="â‚ª" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 font-bold text-lg focus:ring-2 focus:ring-slate-200 outline-none">
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×©×™×•×š (×‘×¢×œ×™×)</label>
                    <select id="ownerInput" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                        <option>××‘×</option>
                        <option>×××</option>
                        <option>×™×œ×“ 1</option>
                        <option>×™×œ×“ 2</option>
                        <option>××©×•×ª×£</option>
                    </select>
                </div>

                <div id="savingsTypeGroup">
                    <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×¡×•×’ ×”× ×›×¡</label>
                    <select id="savingsType" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                        <option>×¤× ×¡×™×”</option>
                        <option>×§×¨×Ÿ ×”×©×ª×œ××•×ª</option>
                        <option>×—×™×¡×›×•×Ÿ ×‘×‘× ×§ / ×¤×™×§×“×•×Ÿ</option>
                        <option>×—×™×¡×›×•×Ÿ ×œ×™×œ×“ / ×’××œ ×œ×”×©×§×¢×”</option>
                        <option>×ª×™×§ ×”×©×§×¢×•×ª</option>
                        <option>× ×“×œ"×Ÿ / ×‘×™×ª ××’×•×¨×™×</option>
                    </select>
                    
                    <div class="mt-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <label class="text-[10px] text-slate-500 font-bold mb-2 block uppercase">×“××™ × ×™×”×•×œ (××•×¤×¦×™×•× ×œ×™)</label>
                        <div class="flex gap-3">
                            <div class="relative w-1/2">
                                <span class="absolute right-2 top-2 text-xs text-gray-400">%</span>
                                <input id="feeDeposit" type="number" step="0.1" placeholder="××”×¤×§×“×”" class="w-full p-1.5 pr-6 text-sm rounded border border-gray-200">
                            </div>
                            <div class="relative w-1/2">
                                <span class="absolute right-2 top-2 text-xs text-gray-400">%</span>
                                <input id="feeAccum" type="number" step="0.01" placeholder="××¦×‘×™×¨×”" class="w-full p-1.5 pr-6 text-sm rounded border border-gray-200">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loansTypeGroup" class="hidden">
                    <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×¡×•×’ ×”×—×•×‘</label>
                    <select id="loansType" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                        <option>××©×›× ×ª×</option>
                        <option>×”×œ×•×•××” ×œ×¨×›×‘</option>
                        <option>×”×œ×•×•××” ××”×•×¨×™×</option>
                        <option>×”×œ×•×•××” ×‘× ×§××™×ª</option>
                        <option>××™× ×•×¡ ×‘×‘× ×§</option>
                    </select>

                    <div class="mt-3">
                        <label class="text-[11px] font-bold text-gray-500 uppercase mb-1 block">×¡×›×•× ×”×”×œ×•×•××” ×”××§×•×¨×™ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="number" id="originalAmountInput" placeholder="â‚ª ×¡×›×•× ×©× ×œ×§×—" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                    </div>
                </div>

                <button onclick="saveEntry()" class="btn-action bg-emerald-600 mt-2 shadow-lg shadow-emerald-100" id="saveBtn">×©××•×¨ × ×›×¡</button>
            </div>

            <div class="flex justify-between mt-6 pt-4 border-t border-gray-100 text-xs text-gray-400 font-medium">
                <button onclick="downloadTemplate()" class="hover:text-blue-600 transition flex items-center gap-1">ğŸ“¥ ×”×•×¨×“ ×ª×‘× ×™×ª</button>
                <button onclick="clearAllData()" class="hover:text-red-500 transition flex items-center gap-1">ğŸ—‘ï¸ ××™×¤×•×¡ ×”×›×œ</button>
                <label class="cursor-pointer hover:text-blue-600 transition flex items-center gap-1">
                    ğŸ“‚ ×™×™×‘×•× ××§×¡×œ
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx,.xls">
                </label>
            </div>
        </div>
    </div>

    <script>
        // --- × ×™×”×•×œ × ×ª×•× ×™× ---
        let savingsData = JSON.parse(localStorage.getItem('mySavings')) || [];
        let loansData = JSON.parse(localStorage.getItem('myLoans')) || [];
        let currentTab = 'savings'; 
        let chartInstances = {}; 

        document.getElementById('dateInput').valueAsDate = new Date();
        renderAll();

        // --- ×××©×§ ---
        function toggleModal() {
            const modal = document.getElementById('addModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            const btnSave = document.getElementById('saveBtn');
            const tabSave = document.getElementById('tabSavings');
            const tabLoan = document.getElementById('tabLoans');
            const groupSave = document.getElementById('savingsTypeGroup');
            const groupLoan = document.getElementById('loansTypeGroup');

            if (tab === 'savings') {
                tabSave.className = 'tab-btn active-save';
                tabLoan.className = 'tab-btn';
                groupSave.classList.remove('hidden');
                groupLoan.classList.add('hidden');
                btnSave.innerText = '×©××•×¨ × ×›×¡';
                btnSave.className = 'btn-action bg-emerald-600 mt-2 shadow-lg shadow-emerald-100';
            } else {
                tabSave.className = 'tab-btn';
                tabLoan.className = 'tab-btn active-loan';
                groupSave.classList.add('hidden');
                groupLoan.classList.remove('hidden');
                btnSave.innerText = '×©××•×¨ ×—×•×‘';
                btnSave.className = 'btn-action bg-red-600 mt-2 shadow-lg shadow-red-100';
            }
        }

        // --- ×©××™×¨×” ---
        function saveEntry() {
            const amount = parseFloat(document.getElementById('amountInput').value);
            if (!amount && amount !== 0) return alert('× × ×œ×”×–×™×Ÿ ×¡×›×•×');

            const entry = {
                Date: document.getElementById('dateInput').value,
                Owner: document.getElementById('ownerInput').value,
                Amount: amount,
                Type: currentTab === 'savings' ? document.getElementById('savingsType').value : document.getElementById('loansType').value,
                FeeDeposit: parseFloat(document.getElementById('feeDeposit').value) || 0,
                FeeAccum: parseFloat(document.getElementById('feeAccum').value) || 0,
                OriginalAmount: currentTab === 'loans' ? (parseFloat(document.getElementById('originalAmountInput').value) || 0) : 0
            };

            if (currentTab === 'savings') {
                savingsData.push(entry);
                savingsData.sort((a,b) => new Date(a.Date) - new Date(b.Date));
                localStorage.setItem('mySavings', JSON.stringify(savingsData));
            } else {
                loansData.push(entry);
                loansData.sort((a,b) => new Date(a.Date) - new Date(b.Date));
                localStorage.setItem('myLoans', JSON.stringify(loansData));
            }

            showToast();
            toggleModal();
            renderAll();
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.className = 'show';
            setTimeout(() => t.className = '', 3000);
        }

        // --- ×¨×™× ×“×•×¨ ---
        function renderAll() {
            const totalAssets = calcLatestTotal(savingsData);
            const totalLiabilities = calcLatestTotal(loansData);
            const netWorth = totalAssets - totalLiabilities;

            document.getElementById('totalAssets').innerText = 'â‚ª' + totalAssets.toLocaleString();
            document.getElementById('totalLiabilities').innerText = 'â‚ª' + totalLiabilities.toLocaleString();
            
            const elNet = document.getElementById('netWorth');
            elNet.innerText = 'â‚ª' + netWorth.toLocaleString();
            elNet.className = netWorth >= 0 ? "text-2xl font-bold text-slate-800" : "text-2xl font-bold text-red-600";

            renderList('savingsList', savingsData, 'asset');
            renderList('loansList', loansData, 'liability');

            renderLineChart('savingsChart', savingsData, '#10b981', '#d1fae5');
            renderPie('savingsPie', 'savingsLegend', savingsData, 
                {
                    '×¤× ×¡×™×”':'#3b82f6', 
                    '×§×¨×Ÿ ×”×©×ª×œ××•×ª':'#fbbf24', 
                    '×—×™×¡×›×•×Ÿ ×‘×‘× ×§ / ×¤×™×§×“×•×Ÿ':'#94a3b8', 
                    '×—×™×¡×›×•×Ÿ ×œ×™×œ×“ / ×’××œ ×œ×”×©×§×¢×”':'#ec4899', 
                    '×ª×™×§ ×”×©×§×¢×•×ª':'#10b981',
                    '× ×“×œ"×Ÿ / ×‘×™×ª ××’×•×¨×™×':'#8b5cf6'
                });

            renderLineChart('loansChart', loansData, '#ef4444', '#fee2e2');
            renderPie('loansPie', 'loansLegend', loansData, 
                {'××©×›× ×ª×':'#991b1b', '×”×œ×•×•××” ×œ×¨×›×‘':'#f97316', '×”×œ×•×•××” ××”×•×¨×™×':'#8b5cf6', '×”×œ×•×•××” ×‘× ×§××™×ª':'#ef4444', '××™× ×•×¡ ×‘×‘× ×§':'#1f2937'});
        }

        function calcLatestTotal(dataArr) {
            if (!dataArr.length) return 0;
            const latest = {};
            dataArr.forEach(item => {
                latest[item.Owner + '_' + item.Type] = item.Amount;
            });
            return Object.values(latest).reduce((a, b) => a + b, 0);
        }

        function renderList(containerId, dataArr, listType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const latestMap = {};
            const changesMap = {};
            
            dataArr.forEach(item => {
                const key = item.Owner + '_' + item.Type;
                const prev = latestMap[key] || 0;
                const diff = (latestMap[key] !== undefined) ? item.Amount - prev : 0;
                
                latestMap[key] = item.Amount;
                changesMap[key] = {
                    amount: item.Amount,
                    diff: diff,
                    date: item.Date,
                    original: item.OriginalAmount || 0, // ×©×•××¨×™× ××ª ×”××§×•×¨×™ ×”××—×¨×•×Ÿ ×©×”×•×–×Ÿ
                    fees: (item.FeeDeposit || item.FeeAccum) ? `×“××™ × ×™×”×•×œ: ${item.FeeDeposit}% / ${item.FeeAccum}%` : ''
                };
            });

            Object.keys(latestMap).forEach(key => {
                const [owner, type] = key.split('_');
                const info = changesMap[key];
                
                let icon = 'ğŸ“„';
                let iconBg = 'bg-gray-100 text-gray-600';

                if (type.includes('×¤× ×¡×™×”')) { icon = 'ğŸ‘´'; iconBg = 'bg-blue-100 text-blue-600'; }
                else if (type.includes('×”×©×ª×œ××•×ª')) { icon = 'ğŸ“š'; iconBg = 'bg-amber-100 text-amber-600'; }
                else if (type.includes('×¨×›×‘')) { icon = 'ğŸš—'; iconBg = 'bg-orange-100 text-orange-600'; }
                else if (type.includes('×‘×™×ª') || type.includes('× ×“×œ') || type.includes('××©×›× ×ª×')) { icon = 'ğŸ '; iconBg = 'bg-purple-100 text-purple-600'; }
                else if (type.includes('×™×œ×“')) { icon = 'ğŸ§¸'; iconBg = 'bg-pink-100 text-pink-600'; }
                else if (type.includes('×”×•×¨×™×')) { icon = 'ğŸ‘ª'; iconBg = 'bg-indigo-100 text-indigo-600'; }
                else if (type.includes('×‘× ×§') || type.includes('××™× ×•×¡')) { icon = 'ğŸ¦'; iconBg = 'bg-slate-200 text-slate-600'; }
                else if (type.includes('×”×©×§×¢×•×ª')) { icon = 'ğŸ“ˆ'; iconBg = 'bg-emerald-100 text-emerald-600'; }

                let diffColorClass = 'text-gray-400'; 
                const diffVal = info.diff;
                const diffSign = diffVal > 0 ? '+' : '';

                if (diffVal !== 0) {
                     diffColorClass = diffVal < 0 ? 'text-red-500 font-bold' : 'text-emerald-500 font-bold';
                }

                // ×œ×•×’×™×§×ª ×¡×›×•× ××§×•×¨×™ (×¨×§ ×œ×”×œ×•×•××•×ª)
                let originalText = '';
                if (listType === 'liability' && info.original > 0) {
                    const percentLeft = Math.min(100, Math.round((info.amount / info.original) * 100));
                    originalText = `
                        <div class="mt-1.5 w-full">
                            <div class="flex justify-between text-[9px] text-gray-400 mb-0.5">
                                <span>×™×ª×¨×”: ${percentLeft}%</span>
                                <span>××§×•×¨: â‚ª${info.original.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-red-400 h-1.5 rounded-full transition-all duration-500" style="width: ${percentLeft}%"></div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML += `
                <div class="entry-card flex-col items-stretch">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="icon-box ${iconBg}">${icon}</div>
                            <div class="mr-3">
                                <div class="font-bold text-sm text-slate-700">${owner} - ${type}</div>
                                <div class="text-[11px] text-gray-400">${info.date}</div>
                                ${info.fees ? `<div class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded inline-block mt-0.5">${info.fees}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-slate-800 text-sm">â‚ª${info.amount.toLocaleString()}</div>
                            <div class="text-[11px] ${diffColorClass}" dir="ltr">
                                ${diffVal !== 0 ? diffSign + diffVal.toLocaleString() : '-'}
                            </div>
                        </div>
                    </div>
                    ${originalText}
                </div>`;
            });
        }

        function renderLineChart(canvasId, dataArr, colorHex, bgHex) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const dates = [...new Set(dataArr.map(d => d.Date))].sort();
            const totals = dates.map(date => {
                let sum = 0;
                const keys = [...new Set(dataArr.map(d => d.Owner + '_' + d.Type))];
                keys.forEach(k => {
                    const matches = dataArr.filter(d => (d.Owner + '_' + d.Type) === k && d.Date <= date);
                    if (matches.length) sum += matches[matches.length - 1].Amount;
                });
                return sum;
            });

            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            if (totals.length === 0) return;

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        data: totals,
                        borderColor: colorHex,
                        backgroundColor: bgHex,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { display: false },
                        y: { 
                            display: true,
                            border: { display: false },
                            grid: { color: '#f1f5f9' },
                            ticks: { callback: v => 'â‚ª' + v.toLocaleString(), font: {size:9} }
                        }
                    },
                    layout: { padding: 10 }
                }
            });
        }

        function renderPie(canvasId, legendId, dataArr, colorMap) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const legend = document.getElementById(legendId);
            
            const latest = {};
            dataArr.forEach(d => { latest[d.Owner + '_' + d.Type] = { type: d.Type, val: d.Amount }; });

            const sumsByType = {};
            Object.values(latest).forEach(obj => {
                sumsByType[obj.type] = (sumsByType[obj.type] || 0) + obj.val;
            });

            const labels = Object.keys(sumsByType);
            const dataVals = Object.values(sumsByType);
            const bgColors = labels.map(l => colorMap[l] || '#94a3b8');

            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            if (dataVals.length === 0) return;

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataVals,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '65%'
                }
            });

            legend.innerHTML = '';
            labels.forEach((lbl, i) => {
                legend.innerHTML += `
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-1.5 overflow-hidden">
                        <div class="w-2 h-2 rounded-full shrink-0" style="background:${bgColors[i]}"></div>
                        <span class="truncate text-slate-600" title="${lbl}">${lbl}</span>
                    </div>
                    <span class="font-bold text-slate-700 shrink-0 ml-2">â‚ª${dataVals[i].toLocaleString()}</span>
                </div>`;
            });
        }

        function clearAllData() {
            if (confirm("×”×× ×œ××—×•×§ ×”×›×œ?")) {
                localStorage.clear();
                savingsData = [];
                loansData = [];
                renderAll();
            }
        }

        function downloadTemplate() {
            const ws1 = XLSX.utils.json_to_sheet([{Category:"Savings",Date:"2025-01-01",Owner:"××‘×",Type:"× ×“×œ\"×Ÿ / ×‘×™×ª ××’×•×¨×™×",Amount:2000000}]);
            const ws2 = XLSX.utils.json_to_sheet([{Category:"Loans",Date:"2025-01-01",Owner:"××©×•×ª×£",Type:"××©×›× ×ª×",Amount:800000,OriginalAmount:1000000}]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, "Savings");
            XLSX.utils.book_append_sheet(wb, ws2, "Loans");
            XLSX.writeFile(wb, "Finance_Template.xlsx");
        }

        document.getElementById('excelFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    rows.forEach(row => {
                        let dateVal = row.Date;
                        if (typeof row.Date === 'number') dateVal = new Date(Math.round((row.Date - 25569)*86400*1000)).toISOString().split('T')[0];
                        
                        const entry = {
                            Date: dateVal,
                            Owner: row.Owner || '×›×œ×œ×™',
                            Type: row.Type,
                            Amount: parseFloat(row.Amount),
                            FeeDeposit: parseFloat(row.FeeDeposit || 0),
                            FeeAccum: parseFloat(row.FeeAccum || 0),
                            OriginalAmount: parseFloat(row.OriginalAmount || 0)
                        };

                        const isLoanSheet = /loan|×”×œ×•×•××•×ª|×—×•×‘×•×ª/i.test(sheetName);
                        const isLoanRow = row.Category === 'Loans' || 
                                          ['××©×›× ×ª×','×”×œ×•×•××”','××™× ×•×¡','×—×•×‘'].some(x => row.Type && row.Type.includes(x));
                        
                        if (isLoanSheet || isLoanRow) {
                            loansData.push(entry);
                        } else {
                            savingsData.push(entry);
                        }
                    });
                });

                localStorage.setItem('mySavings', JSON.stringify(savingsData));
                localStorage.setItem('myLoans', JSON.stringify(loansData));
                renderAll();
                showToast();
                toggleModal();
                document.getElementById('excelFile').value = '';
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
